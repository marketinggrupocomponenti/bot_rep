import discord
from discord.ext import commands
import sqlite3
from datetime import datetime, timedelta
import os
from dotenv import load_dotenv

# Carregar Token do arquivo .env
load_dotenv()
TOKEN = os.getenv('DISCORD_TOKEN')

# Configura√ß√£o de Inten√ß√µes
intents = discord.Intents.default()
intents.message_content = True
intents.members = True

bot = commands.Bot(command_prefix="!", intents=intents, help_command=None)

# --- BANCO DE DADOS ---
def setup_db():
    conn = sqlite3.connect('reputacao.db')
    cursor = conn.cursor()
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS usuarios (
            id INTEGER PRIMARY KEY,
            rep INTEGER DEFAULT 0,
            ultima_rep TEXT
        )
    ''')
    conn.commit()
    conn.close()

def alterar_rep(user_id, quantidade):
    conn = sqlite3.connect('reputacao.db')
    cursor = conn.cursor()
    cursor.execute('INSERT OR IGNORE INTO usuarios (id, rep) VALUES (?, 0)', (user_id,))
    cursor.execute('UPDATE usuarios SET rep = rep + ? WHERE id = ?', (quantidade, user_id))
    cursor.execute('SELECT rep FROM usuarios WHERE id = ?', (user_id,))
    nova_pontuacao = cursor.fetchone()[0]
    conn.commit()
    conn.close()
    return nova_pontuacao

# --- EVENTOS ---
@bot.event
async def on_ready():
    setup_db()
    print(f'‚úÖ {bot.user.name} est√° online!')
    await bot.change_presence(activity=discord.Game(name="Digite: !ajuda para comandos"))

# --- COMANDOS P√öBLICOS ---

@bot.command()
async def ajuda(ctx):
    """Comando de Ajuda Personalizado"""
    embed = discord.Embed(
        title="üìñ Guia de Comandos - Sistema de Reputa√ß√£o",
        description="Use os comandos abaixo para interagir com o sistema de reputa√ß√£o do servidor.",
        color=discord.Color.blue()
    )
    embed.add_field(name="üåü `!rep @membro`", value="D√° +1 ponto de reputa√ß√£o (1 uso por hora).", inline=False)
    embed.add_field(name="üë§ `!perfil @membro`", value="V√™ a reputa√ß√£o atual de um raider.", inline=False)
    embed.add_field(name="üèÜ `!top`", value="Mostra o ranking dos 100 raider mais confi√°veis.", inline=False)
    
    # Se for admin/mods, mostra comandos extras
    if ctx.author.guild_permissions.manage_messages:
        embed.add_field(name="üõ†Ô∏è Modera√ß√£o", value="`!setrep @membro [valor]` - Define os pontos.\n`!resetar @membro` - Zera os pontos de algu√©m.", inline=False)
    
    embed.set_footer(text="Bot desenvolvido para a comunidade ARC Raiders Brasil")
    await ctx.send(embed=embed)

@bot.command()
@commands.cooldown(1, 3600, commands.BucketType.user)
async def rep(ctx, membro: discord.Member):
    if membro == ctx.author:
        ctx.command.reset_cooldown(ctx)
        return await ctx.send("‚ùå Voc√™ n√£o pode dar reputa√ß√£o a si mesmo!")
    
    nova_pontuacao = alterar_rep(membro.id, 1)
    await ctx.send(f"üåü {ctx.author.mention} deu +1 de reputa√ß√£o para {membro.mention}!")

    # Cargo Autom√°tico aos 100 pontos
    if nova_pontuacao >= 100:
        cargo = discord.utils.get(ctx.guild.roles, name="trocador oficial")
        if cargo and cargo not in membro.roles:
            try:
                await membro.add_roles(cargo)
                await ctx.send(f"üéâ {membro.mention} atingiu **100 pontos** e agora √© um **{cargo.name}**!")
            except discord.Forbidden:
                print("Erro: Sem permiss√£o para gerenciar cargos.")

@bot.command()
async def perfil(ctx, membro: discord.Member = None):
    membro = membro or ctx.author
    conn = sqlite3.connect('reputacao.db')
    cursor = conn.cursor()
    cursor.execute('SELECT rep FROM usuarios WHERE id = ?', (membro.id,))
    res = cursor.fetchone()
    pontos = res[0] if res else 0
    conn.close()
    
    embed = discord.Embed(title=f"Perfil de {membro.display_name}", color=discord.Color.green())
    embed.add_field(name="Reputa√ß√£o Atual", value=f"‚ú® `{pontos}` pontos")
    embed.set_thumbnail(url=membro.display_avatar.url)
    await ctx.send(embed=embed)

@bot.command()
async def top(ctx):
    conn = sqlite3.connect('reputacao.db')
    cursor = conn.cursor()
    cursor.execute('SELECT id, rep FROM usuarios ORDER BY rep DESC LIMIT 100')
    leaderboard = cursor.fetchall()
    conn.close()

    if not leaderboard:
        return await ctx.send("O ranking ainda est√° vazio!")

    embed = discord.Embed(title="üèÜ Melhores Trocadores (Top 100)", color=discord.Color.gold())
    
    descricao = ""
    for i, (user_id, pontos) in enumerate(leaderboard, 1):
        user = bot.get_user(user_id)
        nome = user.name if user else f"ID:{user_id}"
        descricao += f"`#{i:02d}` **{nome}** ‚Äî {pontos} reps\n"
        if i == 20: # Limita a exibi√ß√£o visual no embed para n√£o ficar gigante
            descricao += "\n*... exibindo apenas os mais bem avaliados.*"
            break
            
    embed.description = descricao
    await ctx.send(embed=embed)

# --- COMANDOS DE STAFF ---

@bot.command()
@commands.has_permissions(manage_messages=True)
async def setrep(ctx, membro: discord.Member, valor: int):
    alterar_rep(membro.id, 0)
    conn = sqlite3.connect('reputacao.db')
    cursor = conn.cursor()
    cursor.execute('UPDATE usuarios SET rep = ? WHERE id = ?', (valor, membro.id))
    conn.commit()
    conn.close()
    await ctx.send(f"‚úÖ Reputa√ß√£o de {membro.mention} definida para `{valor}`.")

@bot.command()
@commands.has_permissions(administrator=True)
async def resetar(ctx, membro: discord.Member):
    conn = sqlite3.connect('reputacao.db')
    cursor = conn.cursor()
    cursor.execute('UPDATE usuarios SET rep = 0 WHERE id = ?', (membro.id,))
    conn.commit()
    conn.close()
    await ctx.send(f"‚ö†Ô∏è A reputa√ß√£o de {membro.mention} foi resetada para zero.")

# --- TRATAMENTO DE ERROS ---
@bot.event
async def on_command_error(ctx, error):
    if isinstance(error, commands.CommandOnCooldown):
        tempo = str(timedelta(seconds=int(error.retry_after)))
        await ctx.send(f"‚è≥ Calma! Voc√™ pode dar rep novamente em `{tempo}`.")
    elif isinstance(error, commands.MissingPermissions):
        await ctx.send("‚ùå Voc√™ n√£o tem permiss√£o para usar este comando.")
    elif isinstance(error, commands.MemberNotFound):
        await ctx.send("‚ùå N√£o consegui encontrar esse raider.")

bot.run(TOKEN)